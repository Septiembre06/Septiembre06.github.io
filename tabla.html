<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tabla de Posiciones - Copa Raúl Roja</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos minimalistas para parecerse a la imagen adjunta */
    body { background:#071223; color:#e6eef8; }
    .container { max-width:980px; margin:32px auto; padding:0 16px; }
    .standings-card { background:transparent; border:0; }
    .table-wrap { background:#0b1520; border-radius:8px; padding:18px; }
    .standings-table { width:100%; border-collapse:collapse; font-family:Inter, system-ui, Arial; }
    .standings-table thead th { color:#9fb3c8; text-align:left; padding:12px 8px; font-weight:600; font-size:13px; }
    .standings-table tbody tr { border-top:1px solid rgba(255,255,255,0.03); }
    .pos { width:48px; padding:12px 8px; color:#7ee787; font-weight:700; }
    .team { padding:12px 8px; display:flex; align-items:center; gap:12px; }
    .team .badge { width:36px; height:36px; border-radius:50%; overflow:hidden; box-shadow:0 0 0 3px rgba(0,0,0,0.4) inset; }
    .team .team-name { font-weight:700; color:#e6eef8; }
    .standings-table td { padding:12px 8px; color:#cfe7f5; font-size:14px; }
    .stat-num { font-weight:700; }
    @media (max-width:720px){ .container{padding:0 12px;} .standings-table thead th:nth-child(4), .standings-table td:nth-child(4) { display:none; } }
  </style>
  <meta name="description" content="Tabla de posiciones del torneo Copa Raúl Roja">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <h1 class="logo">Copa <span class="highlight">Raúl Rojas</span></h1>
      <nav class="nav">
        <a href="index.html#home">Inicio</a>
        <a href="tabla.html" aria-current="page">Tabla</a>
        <a href="calendar.html">Calendario</a>
        <a href="equipos.html">Equipos</a>
        <a href="estadisticas.html">Estadísticas</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="section card standings-card">
        <div class="standings-header">
          <div>
            <h3>Tabla de Posiciones - Copa Raul Rojas</h3>
            <p class="muted">Sigue la clasificación de los equipos</p>
          </div>
          <div class="standings-actions">
            <a href="index.html" class="btn ghost">Volver</a>
          </div>
        </div>

        <div class="table-wrap">
          <table class="standings-table" aria-label="Tabla de posiciones">
            <thead>
              <tr>
                <th>Pos</th>
                <th>Equipo</th>
                <th>Pts</th>
                <th>PJ</th>
                <th>G</th>
                <th>E</th>
                <th>P</th>
                <th>GF</th>
                <th>GC</th>
                <th>DG</th>
              </tr>
            </thead>
            <tbody id="standingsBody">
              <tr><td colspan="10" class="muted">Cargando clasificación...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© Copa Raúl Roja — Todos los derechos reservados</p>
    </div>
  </footer>
</body>

<script>
  // Mapa inicial de equipos -> logo (mantener consistencia visual)
  const TEAMS = {
    'Gladiadores': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/32314b3b-6ef8-4e0a-a5f2-0c9b08c75961/logo.jpg',
    'FC 9no': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/d00bbe10-d6d8-470a-8ef3-2a4ab27c58c3/logo.jpg',
    'Los Descalsos': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/0b203679-a1c9-49b1-a316-e2a588495d6f/logo.jpg?v=1758390280487',
    'Gamboleros': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/afe8cc36-d1b7-4052-ad89-99443c3e52f0/logo.jpg?v=1758388008060',
    'Scorpions': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/a9e7ac21-550a-4350-82ae-677979f69a81/logo.jpg?v=1758735227385',
    'Klan': 'https://sclrcoiisappnzbaxlzc.supabase.co/storage/v1/object/public/team-logos/teams/37af335f-ef37-4d61-8221-801e13d64713/logo.jpg?v=1758392886644'
  };

  function matchKey(a,b,t){ return `match::${encodeURIComponent(a)}::${encodeURIComponent(b)}::${encodeURIComponent(t||'')}`; }

  function computeStandings(){
    const teams = {};
    // initialize teams from TEAMS map
    function isValidTeamName(n){ if(!n) return false; return n.toString().trim().toLowerCase() !== 'ultras'; }
    Object.keys(TEAMS).forEach(name=>{
      if(!isValidTeamName(name)) return;
      teams[name] = {name,logo:TEAMS[name],pts:0,pj:0,w:0,d:0,l:0,gf:0,gc:0};
    });

    // scan localStorage for match keys
    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      if(!key || !key.startsWith('match::')) continue;
      try{
        const raw = localStorage.getItem(key);
        if(!raw) continue;
        const m = JSON.parse(raw);
        const a = m.team1; const b = m.team2; const s1 = parseInt(m.score1||0,10); const s2 = parseInt(m.score2||0,10);
        if(!isValidTeamName(a) || !isValidTeamName(b)) continue;
        if(!teams[a]) teams[a] = {name:a,logo:'',pts:0,pj:0,w:0,d:0,l:0,gf:0,gc:0};
        if(!teams[b]) teams[b] = {name:b,logo:'',pts:0,pj:0,w:0,d:0,l:0,gf:0,gc:0};

        teams[a].pj += 1; teams[b].pj += 1;
        teams[a].gf += s1; teams[a].gc += s2;
        teams[b].gf += s2; teams[b].gc += s1;

        if(s1 > s2){ teams[a].w += 1; teams[a].pts += 3; teams[b].l += 1; }
        else if(s1 < s2){ teams[b].w += 1; teams[b].pts += 3; teams[a].l += 1; }
        else { teams[a].d += 1; teams[b].d += 1; teams[a].pts += 1; teams[b].pts += 1; }
      }catch(e){ console.error('invalid match entry', key, e); }
    }

    // compute dg
    Object.values(teams).forEach(t=> t.dg = (t.gf - t.gc));

    // sort
    const sorted = Object.values(teams).sort((x,y)=>{
      if(y.pts !== x.pts) return y.pts - x.pts;
      if(y.dg !== x.dg) return y.dg - x.dg;
      if(y.gf !== x.gf) return y.gf - x.gf;
      return x.name.localeCompare(y.name);
    });
    return sorted;
  }

  function renderTable(){
    const body = document.getElementById('standingsBody');
    const rows = computeStandings();
    body.innerHTML = '';
    if(!rows.length){ body.innerHTML = '<tr><td colspan="10" class="muted">Sin datos</td></tr>'; return; }
    rows.forEach((t, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="pos">${idx+1}</td>
        <td class="team"><span class="badge"><img src="${t.logo||'https://via.placeholder.com/36'}" alt="${t.name}" style="width:100%;height:100%;object-fit:cover;"></span><span class="team-name">${t.name}</span></td>
        <td class="stat-num">${t.pts}</td>
        <td>${t.pj}</td>
        <td>${t.w}</td>
        <td>${t.d}</td>
        <td>${t.l}</td>
        <td>${t.gf}</td>
        <td>${t.gc}</td>
        <td>${t.dg}</td>
      `;
      body.appendChild(tr);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    renderTable();
  });

  // update on storage changes (other tabs) and on explicit storage events
  window.addEventListener('storage', (e)=>{ if(e.key && e.key.startsWith('match::')) renderTable(); });

  // also listen for custom event to refresh (in case same-tab save doesn't trigger storage)
  window.addEventListener('matches-updated', renderTable);

</script>
</body>
</html>
